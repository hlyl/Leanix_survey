services:
  # FastAPI Backend Service
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: leanix-api
    ports:
      - "8000:8000"
    environment:
      # LeanIX Configuration (set via .env or pass at runtime)
      - LEANIX_URL=${LEANIX_URL:-https://your-instance.leanix.net}
      - LEANIX_API_TOKEN=${LEANIX_API_TOKEN:-your-token-here}
      - LEANIX_WORKSPACE_ID=${LEANIX_WORKSPACE_ID:-your-workspace-uuid}
      
      # Backend Configuration
      - BACKEND_URL=http://api:8000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - MAX_BATCH_SIZE=${MAX_BATCH_SIZE:-25}
      - API_TIMEOUT=${API_TIMEOUT:-30}
      
      # Python Configuration
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    
    networks:
      - leanix-network
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    
    restart: unless-stopped
    volumes:
      - ./src:/app/src:ro  # Read-only for production
    
    depends_on: []

  # Streamlit Frontend Service
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: leanix-frontend
    ports:
      - "8502:8502"
    environment:
      # Backend URL for Streamlit to communicate with API
      - BACKEND_URL=http://api:8000
      
      # Streamlit Configuration
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_PORT=8502
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_LOGGER_LEVEL=${LOG_LEVEL:-INFO}
      
      # LeanIX Configuration (for direct access if needed)
      - LEANIX_URL=${LEANIX_URL:-https://your-instance.leanix.net}
      - LEANIX_API_TOKEN=${LEANIX_API_TOKEN:-your-token-here}
      - LEANIX_WORKSPACE_ID=${LEANIX_WORKSPACE_ID:-your-workspace-uuid}
      
      # Python Configuration
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    
    networks:
      - leanix-network
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8502/_stcore/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    
    restart: unless-stopped
    volumes:
      - ./src:/app/src:ro  # Read-only for production
      - ./examples:/app/examples:ro  # Example surveys
    
    depends_on:
      - api

# Network for service-to-service communication
networks:
  leanix-network:
    driver: bridge

# Optional: Volumes for persistent data
volumes:
  api-data:
    driver: local
  frontend-data:
    driver: local
